VERSION 5.00
Object = "{86CF1D34-0C5F-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCT2.OCX"
Begin VB.Form frmBiaEXploitation 
   Caption         =   "Bia_Exploitation"
   ClientHeight    =   6345
   ClientLeft      =   60
   ClientTop       =   345
   ClientWidth     =   9405
   LinkTopic       =   "Form1"
   ScaleHeight     =   6345
   ScaleWidth      =   9405
   Begin VB.Frame fraBiaExploitation 
      Height          =   5775
      Left            =   0
      TabIndex        =   2
      Top             =   360
      Width           =   9255
      Begin VB.CommandButton cmdImportCptP0 
         Caption         =   "Import CptP0"
         Height          =   615
         Left            =   8040
         TabIndex        =   19
         Top             =   3600
         Visible         =   0   'False
         Width           =   1095
      End
      Begin VB.Frame fraList 
         Caption         =   "Etats"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   5295
         Left            =   3120
         TabIndex        =   8
         Top             =   360
         Width           =   4455
         Begin VB.Frame fraJournal 
            Height          =   2175
            Left            =   240
            TabIndex        =   23
            Top             =   240
            Width           =   3735
            Begin VB.CheckBox chkAvis 
               Caption         =   "Impression des avis (SOBF :2 ex)"
               Height          =   300
               Left            =   120
               TabIndex        =   30
               Top             =   1680
               Value           =   1  'Checked
               Width           =   3495
            End
            Begin VB.OptionButton optJournalTriP 
               Caption         =   "tri / Pièce"
               Height          =   195
               Left            =   1800
               TabIndex        =   29
               Top             =   1080
               Width           =   1215
            End
            Begin VB.OptionButton optJournalTriC 
               Caption         =   "tri / Compte"
               Height          =   255
               Left            =   1800
               TabIndex        =   28
               Top             =   1320
               Width           =   1335
            End
            Begin VB.CheckBox chkJournalComptable 
               Caption         =   "Journal comptable"
               Height          =   300
               Left            =   120
               TabIndex        =   25
               Top             =   240
               Value           =   1  'Checked
               Width           =   1695
            End
            Begin VB.CheckBox chkJournalAmj 
               Caption         =   "du"
               Height          =   255
               Left            =   1800
               TabIndex        =   24
               Top             =   240
               Width           =   495
            End
            Begin MSComCtl2.DTPicker txtJournalAmj 
               Height          =   300
               Left            =   2280
               TabIndex        =   26
               Top             =   240
               Width           =   1335
               _ExtentX        =   2355
               _ExtentY        =   529
               _Version        =   393216
               CalendarBackColor=   16777215
               CalendarForeColor=   0
               CalendarTitleBackColor=   8421504
               CalendarTitleForeColor=   16777215
               CalendarTrailingForeColor=   12632256
               CustomFormat    =   "dd  MM yyy"
               Format          =   65798147
               CurrentDate     =   36299
               MaxDate         =   401768
               MinDate         =   -328351
            End
            Begin MSComCtl2.DTPicker txtJournalAmjAu 
               Height          =   300
               Left            =   2280
               TabIndex        =   27
               Top             =   720
               Width           =   1335
               _ExtentX        =   2355
               _ExtentY        =   529
               _Version        =   393216
               CalendarBackColor=   16777215
               CalendarForeColor=   0
               CalendarTitleBackColor=   8421504
               CalendarTitleForeColor=   16777215
               CalendarTrailingForeColor=   12632256
               CustomFormat    =   "dd  MM yyy"
               Format          =   65798147
               CurrentDate     =   36299
               MaxDate         =   401768
               MinDate         =   -328351
            End
         End
         Begin VB.CheckBox chkSolde6 
            Caption         =   "Etat des soldes"
            Height          =   300
            Left            =   240
            TabIndex        =   22
            Top             =   4800
            Value           =   1  'Checked
            Width           =   4095
         End
         Begin VB.CheckBox chkSolde5 
            Caption         =   "Etat des soldes"
            Height          =   300
            Left            =   240
            TabIndex        =   21
            Top             =   4440
            Value           =   1  'Checked
            Width           =   4095
         End
         Begin VB.CheckBox chkSolde4 
            Caption         =   "Etat des soldes"
            Height          =   300
            Left            =   240
            TabIndex        =   13
            Top             =   4080
            Value           =   1  'Checked
            Width           =   4095
         End
         Begin VB.CheckBox chkSolde3 
            Caption         =   "Etat des soldes"
            Height          =   300
            Left            =   240
            TabIndex        =   12
            Top             =   3720
            Value           =   1  'Checked
            Width           =   4095
         End
         Begin VB.CheckBox chkSolde2 
            Caption         =   "Etat des soldes"
            Height          =   300
            Left            =   240
            TabIndex        =   11
            Top             =   3360
            Value           =   1  'Checked
            Width           =   4095
         End
         Begin VB.CheckBox chkTOpe 
            Caption         =   "Echéancier"
            Height          =   300
            Left            =   240
            TabIndex        =   10
            Top             =   2640
            Value           =   1  'Checked
            Width           =   3975
         End
         Begin VB.CheckBox chkSolde1 
            Caption         =   "Etat des soldes"
            Height          =   300
            Left            =   240
            TabIndex        =   9
            Top             =   3000
            Value           =   1  'Checked
            Width           =   4095
         End
      End
      Begin VB.Frame fraService 
         Caption         =   "Service"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   5415
         Left            =   240
         TabIndex        =   4
         Top             =   240
         Width           =   2775
         Begin VB.OptionButton optServiceInspection 
            Caption         =   "Inspection"
            Height          =   255
            Left            =   240
            TabIndex        =   20
            Top             =   4320
            Width           =   2175
         End
         Begin VB.OptionButton optServiceRisques 
            Caption         =   "Risques"
            Height          =   255
            Left            =   240
            TabIndex        =   18
            Top             =   4680
            Width           =   2175
         End
         Begin VB.OptionButton optServiceCompta 
            Caption         =   "Compta"
            Height          =   255
            Left            =   240
            TabIndex        =   17
            Top             =   2640
            Width           =   2175
         End
         Begin VB.OptionButton optServiceOpTrf 
            Caption         =   "OpTrf"
            Height          =   255
            Left            =   240
            TabIndex        =   16
            Top             =   1200
            Width           =   2175
         End
         Begin VB.OptionButton optServiceDG 
            Caption         =   "DG"
            Height          =   255
            Left            =   240
            TabIndex        =   15
            Top             =   2280
            Width           =   2175
         End
         Begin VB.OptionButton optServiceBOTC 
            Caption         =   "BOTC"
            Height          =   255
            Left            =   240
            TabIndex        =   14
            Top             =   1920
            Width           =   2175
         End
         Begin VB.OptionButton optServiceSOBI 
            Caption         =   "SOBI"
            Height          =   255
            Left            =   240
            TabIndex        =   7
            Top             =   840
            Width           =   2175
         End
         Begin VB.OptionButton optServiceDafi 
            Caption         =   "DAFI"
            Height          =   255
            Left            =   240
            TabIndex        =   6
            Top             =   1560
            Width           =   2175
         End
         Begin VB.OptionButton optServiceCaisse 
            Caption         =   "Caisse"
            Height          =   255
            Left            =   240
            TabIndex        =   5
            Top             =   480
            Width           =   2175
         End
      End
      Begin VB.CommandButton cmdPrint 
         BackColor       =   &H00E0E0E0&
         Height          =   1215
         Left            =   7800
         Picture         =   "BiaEXploitation.frx":0000
         Style           =   1  'Graphical
         TabIndex        =   3
         Top             =   720
         Width           =   1245
      End
   End
   Begin VB.CommandButton cmdContext 
      BackColor       =   &H00E0E0E0&
      Caption         =   "&Abandonner"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   0
      Style           =   1  'Graphical
      TabIndex        =   1
      Top             =   0
      Width           =   1200
   End
   Begin VB.ListBox lstErr 
      BackColor       =   &H00E0E0E0&
      ForeColor       =   &H000000FF&
      Height          =   255
      Left            =   5400
      TabIndex        =   0
      Top             =   0
      Width           =   3945
   End
End
Attribute VB_Name = "frmBiaEXploitation"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Dim arrTag() As Boolean, arrTagNb As Integer, lstErrClear As Boolean
Dim currentAction As String
Dim MouseMoveActiveControl_Name  As String, MouseMoveActiveControl As typeUsrColor
Dim lastActiveControl_Name  As String, currentActiveControl_Name As String
Dim blnMsgBox_Quit As Boolean, blnControl As Boolean
Dim BiaExploitationAut As typeAuthorization
Dim X As String, X1 As String, I As Long
Dim valX As String, V As Variant
Dim reccptp0 As typeCptP0
Dim recCptInfo As typeCptInfo
Dim recCptMvt As typeCptMvt

Dim SrvMvtP0_Amj As String * 8, SrvCptP0_Amj_Ok As String
Dim cmdImport_Select_Nb As Long, cmdImport_Nb As Long

Dim valAmjMin As String * 8, valAmjMax As String * 8

Dim mService As String * 3
Dim paramComptaExt_Mvt_Import As String
Dim blnPièceRupture As Boolean, txtPièceRupture As String

Dim blnJournalAmj As Boolean, mJournalAmj As String * 8, mJournalAmjAu As String * 8

Dim IGTable As typeElpTable, mCompte As String * 11, blnIGTable As Boolean
Dim mIGAMJVal_Min As String * 8, mIGAMJVal_Max As String * 8
Dim blnImportCptp0 As Boolean

Dim recOpCpt As typeOpCpt
Dim blnImport_Mvtp0 As Boolean
'-------------------------------------------------'
Private Sub txtJournalAmj_Control()
'-------------------------------------------------'

Dim X As String
X = Format$(txtJournalAmj.Year, "0000") & Format$(txtJournalAmj.Month, "00") & Format$(txtJournalAmj.Day, "00")
If Not IsNumeric(X) Then
    Call lstErr_AddItem(lstErr, cmdContext, "? erreur date")
    DTPicker_Now txtJournalAmj
Else
    mJournalAmj = mId$(X, 1, 8)
    
End If

End Sub


Public Sub cmdControl()
Dim wX As String

If Not Me.Enabled Then Exit Sub
Me.Enabled = False
blnControl = False

lstErr.Clear
lstErr.Height = 200

If optJournalTriP Then
    blnPièceRupture = True: txtPièceRupture = "Service_Pièce"
Else
    blnPièceRupture = False: txtPièceRupture = "Service_Compte"
End If
If mService = "080" Then blnPièceRupture = False: txtPièceRupture = "Liste_Compte"

'If lstErr.ListCount = 0 Then cmdPrint.Visible = True

ExitSub:

Me.Enabled = True
blnControl = True

End Sub

Public Sub Msg_Rcv(Msg As String)
'---------------------------------------------------------
Call BiaPgmAut_Init("BIA_Exploit", BiaExploitationAut)
param_Init
cmdReset
Select Case UCase$(Trim(mId$(Msg, 1, 12)))
    Case "@BIA_EXPLOIT":     cmdPrint_Click: Unload Me
End Select

End Sub


Private Sub chkJournalAmjAu_Click()

End Sub

Private Sub cmdPrint_Click()
Dim Msg As String

Me.Enabled = False

cmdControl
blnImportCptp0 = True
Select Case mService
        Case "080": cmdPrint_Inspection
        Case Else: cmdPrint_Service
End Select
    
Me.Enabled = True
AppActivate Me.Caption

End Sub


'---------------------------------------------------------
Private Sub Form_KeyUp(KeyCode As Integer, Shift As Integer)
'---------------------------------------------------------
Select Case KeyCode
    Case Is = 13: KeyCode = 0: cmdContext_Return
    Case Is = 27: cmdContext_Quit
    Case Is = 44: KeyCode = 0: frmElpPrt.prtScreen
End Select

End Sub


Private Sub Form_Load()
Set XForm = Me
Call MeInit(arrTagNb)
ReDim arrTag(arrTagNb + 1)
mJournalAmj = DValPrevious
mJournalAmjAu = DValPrevious
blnImportCptp0 = False
DTPicker_Set txtJournalAmj, mJournalAmj
DTPicker_Set txtJournalAmjAu, mJournalAmjAu
End Sub


Private Sub Form_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
MouseMoveActiveControl_Reset
End Sub

Public Sub MouseMoveActiveControl_Reset()
For Each xobj In Me.Controls
    If MouseMoveActiveControl_Name = xobj.Name Then
        MouseMoveActiveControl_Name = ""
         If TypeOf xobj Is CommandButton Or TypeOf xobj Is ListBox Then
           xobj.BackColor = MouseMoveActiveControl.BackColor
        Else
            xobj.ForeColor = MouseMoveActiveControl.ForeColor
        End If
        Exit For
    End If
Next xobj

End Sub

Public Sub MouseMoveActiveControl_Set(C As Control)
If MouseMoveActiveControl_Name <> C.Name Then
    MouseMoveActiveControl_Reset
    If Not C.Enabled Then
        MouseMoveActiveControl_Name = ""
    Else
        MouseMoveActiveControl_Name = C.Name
        If TypeOf C Is CommandButton Or TypeOf C Is ListBox Then
            
            MouseMoveActiveControl.BackColor = C.BackColor
            C.BackColor = MouseMoveUsr.BackColor
        Else
            MouseMoveActiveControl.ForeColor = C.ForeColor
            C.ForeColor = MouseMoveUsr.ForeColor
        End If
    End If
End If

End Sub
Private Sub cmdContext_Click()
Select Case cmdContext.Caption
    Case Is = constcmdRechercher:
    Case Is = constcmdAbandonner: cmdContext_Quit
End Select

End Sub



'-------------------------------------------------------
Sub txt_GotFocus(C As Control)
'-------------------------------------------------------
C.ForeColor = txtUsr.ForeColor
C.BackColor = focusUsr.BackColor
currentActiveControl_Name = C.Name
End Sub

'-------------------------------------------------------
Sub txt_LostFocus(C As Control)
'-------------------------------------------------------
lstErr.Clear
arrTag(Val(C.Tag)) = True
C.ForeColor = txtUsr.ForeColor
C.BackColor = txtUsr.BackColor
End Sub

Public Sub cmdContext_Quit()
Unload Me
End Sub

Public Sub cmdContext_Return()

End Sub

Private Function cmdImport_MvtP0()
Dim xInput As String, blnOk As Boolean, blnSelect As Boolean
Dim vReturn As Variant, wService As String * 3, curX As Currency
Dim I As Long
Dim X8 As String

cmdImport_MvtP0 = "?"

On Error Resume Next
mCompte = ""
recElpTable_Init IGTable
IGTable.Method = "Seek="
IGTable.Id = "Param"
IGTable.K1 = "IG_Mvt_Sel"
blnIGTable = False

blnOk = False
cmdImport_Select_Nb = 0: cmdImport_Nb = 0: I = 0

X = Dir(paramComptaExt_Mvt_Import)
If X = "" Then Call lstErr_Clear(lstErr, cmdPrint, "? Le fichier des mouvements n'existe pas"): Exit Function

Call lstErr_AddItem(lstErr, cmdPrint, "Chargement des mouvements, tri ...")

MDB.Execute "delete * from MvtP0"
mdbMvtP0.tableMvtP0_Open

Call DTPicker_Control(txtJournalAmj, mJournalAmj)
Call DTPicker_Control(txtJournalAmjAu, mJournalAmjAu)

If chkJournalAmj = "1" Then
    'txtJournalAmj_Control

    Open Trim(paramComptaExt_Mvt_Import) & "_Mois" For Input As #1
Else
    Open paramComptaExt_Mvt_Import For Input As #1
End If

mIGAMJVal_Min = dateElp("MoisAdd", -2, mJournalAmj)
mIGAMJVal_Max = dateElp("Jour", 10, mJournalAmj)

recMvtP0_Init recMvtp0
recMvtp0.Method = "AddNew"


Do Until EOF(1)
    Line Input #1, xInput
    
        
    If mId$(xInput, 1, 3) = "$$$" Then
        blnOk = True
        SrvMvtP0_Amj = mId$(xInput, 86, 8)
        I = Val(mId$(xInput, 94, 9))
        If I <> cmdImport_Nb Then
            cmdImport_Select_Nb = 0
            Call MsgBox("erreur : nombre enregistrements lus", vbCritical, "frmCompteEXtrait : cmdImport_Cptp0 :SrvMvtP0 ")
        End If
        Exit Do
    End If
    I = I + 1
    cmdImport_Nb = cmdImport_Nb + 1
    blnSelect = False
    
    Select Case mService
        Case "080"   ' inspection
            blnSelect = cmdImport_MvtP0_Inspection(xInput)
        Case Else
               wService = mId$(xInput, 25, 3)
               If wService = mService Then
                   blnSelect = True
                   If chkJournalAmj = "1" Then
                        X8 = mId$(xInput, 163, 8)
                       If X8 < mJournalAmj Or X8 > mJournalAmjAu Then blnSelect = False
                   End If
                End If
        End Select
        If blnSelect Then
             If blnPièceRupture Then
                 recMvtp0.Id = wService & mId$(xInput, 7, 3) & mId$(xInput, 71, 11) & Format$(cmdImport_Nb, "0000000") ' devise compte date trt no pièce no ligne
             Else
                 curX = CCur(Val(mId$(xInput, 28, 19)))
                 recMvtp0.Id = wService & mId$(xInput, 7, 3) & mId$(xInput, 10, 11) & Format$(Abs(curX), "0000000000000000") & Format$(cmdImport_Nb, "0000000")  ' devise compte date trt no pièce no ligne
            End If
            recMvtp0.Text = xInput
                 cmdImport_Select_Nb = cmdImport_Select_Nb + 1
                 dbMvtP0_Update recMvtp0
        End If
    If I = 1000 Then I = 0: Call lstErr_ChangeLastItem(lstErr, cmdPrint, "Sélection des mouvements: " & cmdImport_Select_Nb & " / " & cmdImport_Nb): DoEvents
 
Loop

Close
mdbMvtP0.tableMvtP0_Close

If Not blnOk Then
    cmdImport_Select_Nb = 0
    Call MsgBox("erreur : manque fin de fichier ", vbCritical, "frmCompteEXtrait : cmdImport_Cptp0 :SrvMvtP0 ")
Else
    cmdImport_MvtP0 = Null
    blnImport_Mvtp0 = True
End If
If chkJournalAmj <> "1" Then mJournalAmj = SrvMvtP0_Amj

End Function

Private Sub cmdImportCptP0_click()
Dim xInput As String, blnOk As Boolean
On Error Resume Next

Dim I As Integer, cmdImport_Select_Nb As Integer, cmdImport_Nb As Integer
Dim r As Integer

frmCompteSolde.param_Init
'Dim paramComptaSld_Cpt_Import As String
'paramComptaSld_Cpt_Import = "C:\Biasrv\SrvCptp0"

cmdImport_Select_Nb = 0: cmdImport_Nb = 0: I = 0

X = Dir(paramComptaSld_Cpt_Import)
If X = "" Then Call lstErr_Clear(lstErr, cmdPrint, "? Le fichier des comptes n'existe pas"): Exit Sub

Call lstErr_Clear(lstErr, cmdPrint, "Chargement des comptes, tri ...")
Call lstErr_AddItem(lstErr, cmdPrint, "Début ..."): DoEvents

Me.MousePointer = vbHourglass
Me.Enabled = False

mdbCptP0.tableCptP0_Open

Open paramComptaSld_Cpt_Import For Input As #1
recCptP0_Init reccptp0


Do Until EOF(1)
    Line Input #1, xInput
    If mId$(xInput, 1, 3) = "$$$" Then
        blnOk = True
        I = Val(mId$(xInput, 43, 9))
        If I <> cmdImport_Nb Then
            cmdImport_Select_Nb = 0
            Call MsgBox("erreur : nombre enregistrements lus", vbCritical, "me : cmdImport_Cptp0 :SrvCptP0 ")
            Exit Do
        End If
    End If
    cmdImport_Nb = cmdImport_Nb + 1
    reccptp0.Id = mId$(xInput, 1, 9) & mId$(xInput, 13, 11)
    reccptp0.Method = constAddNew
    r = tableCptP0_Read(reccptp0)
    If r = 9998 Then
        r = 0
    Else
        reccptp0.Method = constUpdate
    End If

    reccptp0.Text = xInput
    dbCptP0_Update reccptp0

    If cmdImport_Nb Mod 1000 = 0 Then I = 0: Call lstErr_ChangeLastItem(lstErr, cmdPrint, "Import : " & cmdImport_Nb): DoEvents
 
Loop

Close


mdbCptP0.tableCptP0_Close
Me.MousePointer = 0
Me.Enabled = True

If Not blnOk Then
    cmdImport_Select_Nb = 0
    Call MsgBox("erreur : manque fin de fichier ", vbCritical, "me : cmdImport_Cptp0 :SrvCptP0 ")
Else
    blnImportCptp0 = False
    Call lstErr_ChangeLastItem(lstErr, cmdPrint, "Import terminé : " & cmdImport_Nb)
End If

End Sub


Public Function param_Init()
Dim V
param_Init = Null
recElpTable_Init recElpTable
recElpTable.Id = "Param"
recElpTable.K1 = "Compta"
recElpTable.Method = "Seek="

recElpTable.K2 = "Mvt_Import"
V = dbElpTable_ReadE(recElpTable)
If Not IsNull(V) Then GoTo Table_Error
If IsNull(recElpTable.Memo) Then GoTo Memo_Error
paramComptaExt_Mvt_Import = paramServer(recElpTable.Memo) 'Trim(recElpTable.Memo)
''Call lstErr_AddItem(lstErr, cmdContext, "Cpt_Import:" & paramComptaExt_Mvt_Import)

Exit Function

Table_Error:
param_Init = V
Exit Function

Memo_Error:
param_Init = "Memo"
MsgBox recElpTable.Id & " : " & recElpTable.K1 & " : " & recElpTable.K2 & " : Mémo absent", vbCritical, "Balance_Param_Init"
Exit Function

End Function


Public Sub cmdReset()
blnControl = False
fraService.Enabled = BiaExploitationAut.Saisir
cmdImportCptP0.Visible = BiaExploitationAut.Xspécial
currentAction = ""
If UCase$(usrId) = "BIA_INFO" Then
    optServiceDG = True
Else
    Select Case usrService
        Case "001": optServiceCaisse = True
        Case "002", "003": usrService = "001": optServiceCaisse = True
        Case "010": optServiceSOBI = True
        Case "011": optServiceOpTrf = True
        Case "041": optServiceDafi = True
        Case "050": optServiceBOTC = True
        Case "060": optServiceCompta = True
        Case "070": optServiceRisques = True
        Case "080": optServiceInspection = True
        Case "000": optServiceDG = True
    End Select
End If

recCptInfoInit recCptInfo
recCptInfo.Société = SocId$
recCptInfo.Agence = SocAgence$
blnControl = True
optService_Reset
End Sub





Public Sub optService_Reset()
Dim wService As String

blnPièceRupture = True: txtPièceRupture = "Service_Pièce"
optJournalTriP = True

If optServiceCaisse Then wService = "001": blnPièceRupture = False: optJournalTriC = True ''' blnPièceRupture = False: txtPièceRupture = "Service_Compte"
If optServiceDafi Then wService = "041"
If optServiceSOBI Then wService = "010": blnPièceRupture = False: optJournalTriC = True ''' blnPièceRupture = False: txtPièceRupture = "Service_Compte"
If optServiceOpTrf Then wService = "011"
If optServiceBOTC Then wService = "050"
If optServiceCompta Then wService = "060"
If optServiceRisques Then wService = "070"
If optServiceDG Then wService = "000"
If optServiceInspection Then wService = "080": blnPièceRupture = False: txtPièceRupture = "Liste_Compte"

chkJournalComptable = "1": chkJournalComptable.Enabled = True: chkJournalComptable.Caption = " Journal comptable"
chkTOpe = "0": chkTOpe.Enabled = False: chkTOpe.Caption = "Echéancier "
chkSolde1 = "0": chkSolde1.Enabled = False: chkSolde1.Caption = "Etat des soldes 1"
chkSolde2 = "0": chkSolde2.Enabled = False: chkSolde2.Caption = "Etat des soldes 2"
chkSolde3 = "0": chkSolde3.Enabled = False: chkSolde3.Caption = "Etat des soldes 3"
chkSolde4 = "0": chkSolde4.Enabled = False: chkSolde4.Caption = "Etat des soldes 4"
chkSolde5 = "0": chkSolde5.Enabled = False: chkSolde5.Caption = "Etat des soldes 5"
chkSolde6 = "0": chkSolde6.Enabled = False: chkSolde6.Caption = "Etat des soldes 6"
chkAvis = "0": chkAvis.Enabled = True

'If mService <> wService Then
    mService = wService
    Select Case mService
        Case "001":
                    chkSolde1 = "1": chkSolde1.Enabled = True
                    chkSolde1.Caption = "Etat des soldes 'caisse espèces'"
                    chkTOpe = "1": chkTOpe.Enabled = True
                    chkTOpe.Caption = "Echéancier des prêts"
                    chkAvis = "1": chkAvis.Enabled = True
        Case "010":
                  chkSolde1 = "1": chkSolde1.Enabled = True
                  chkSolde1.Caption = "Etat des soldes 'type/racine'"
                  chkSolde2 = "1": chkSolde2.Enabled = True
                  chkSolde2.Caption = "Etat des soldes 'Banque'"
                  chkSolde3 = "1": chkSolde3.Enabled = True
                  chkSolde3.Caption = "Etat récapitulatif des soldes "
                  chkAvis = "1": chkAvis.Enabled = True
        Case "011":
                  chkSolde1 = "0": chkSolde1.Enabled = False
                  chkSolde1.Caption = "Etat des soldes"
        Case "041":
                  chkSolde1 = "0": chkSolde1.Enabled = True
                  chkSolde1.Caption = "Etat des soldes 'type/racine'"
                  chkTOpe = "1": chkTOpe.Enabled = True
                  chkTOpe.Caption = "Echéancier des garanties"
                  chkAvis = "1": chkAvis.Enabled = True
        Case "050":
                  chkSolde1 = "0": chkSolde1.Enabled = True
                  chkSolde1.Caption = "Etat des soldes 'Banque'"
                  chkSolde2 = "0": chkSolde2.Enabled = True
                  chkSolde2.Caption = "Etat des soldes 'PM'"
        Case "060":
                 ' chkJournalComptable = "0": chkJournalComptable.Enabled = False
                  chkSolde1 = "1": chkSolde1.Enabled = True
                  chkSolde1.Caption = "Etat des soldes 'comptes du personnel'"
                    chkSolde2 = "1": chkSolde2.Enabled = True
                 chkSolde2.Caption = "Etat des soldes 'Conversion 382 120 05'"
                  chkAvis = "1": chkAvis.Enabled = True

         Case "070":
                  chkJournalComptable = "0": chkJournalComptable.Enabled = False
                  chkSolde1 = "1": chkSolde1.Enabled = True
                  chkSolde1.Caption = "Etat des soldes 'Centrale des risques'"
        Case "080":
                  chkJournalComptable.Caption = "Journal de caisse"
                  chkTOpe = "1": chkTOpe.Enabled = True: chkTOpe.Caption = "Mouvements concernant les comptes sous surveillance"
                  chkSolde1 = "1": chkSolde1.Enabled = True: chkSolde1.Caption = "Mouvements dont la date de valeur est hors limites"
                  chkSolde2 = "1": chkSolde2.Enabled = True: chkSolde2.Caption = "Mouvements complémentaires"
                  chkSolde3 = "1": chkSolde3.Enabled = True: chkSolde3.Caption = "Mouvements manuels"
                  chkSolde4 = "1": chkSolde4.Enabled = True: chkSolde4.Caption = "Mouvements sur comptes du personnel"
                  chkSolde5 = "1": chkSolde5.Enabled = True: chkSolde5.Caption = "Mouvements sur comptes : contrôle autorisation"
                  chkSolde6 = "1": chkSolde6.Enabled = True: chkSolde6.Caption = "Comptes : sens du solde anormal"
     Case "000":
                  chkJournalComptable = "0": chkJournalComptable.Enabled = False
                  chkSolde1 = "1": chkSolde1.Enabled = True
                  chkSolde1.Caption = "Etat des soldes DG"
                  chkSolde2 = "1": chkSolde2.Enabled = True
                  chkSolde2.Caption = "Etat des soldes DGA"
                  chkSolde3 = "1": chkSolde3.Enabled = True
                  chkSolde3.Caption = "Etat des soldes Inspection"
                  chkSolde4 = "1": chkSolde4.Enabled = True
                  chkSolde4.Caption = "Etat des soldes Inspection 019"
End Select
'End If

End Sub

Private Sub Form_Unload(Cancel As Integer)
If blnImportCptp0 Then cmdImportCptP0_click
End Sub

Private Sub optServiceBOTC_Click()
If blnControl Then optService_Reset
End Sub

Private Sub optServiceCaisse_Click()
If blnControl Then optService_Reset
End Sub


Private Sub optServiceCompta_Click()
If blnControl Then optService_Reset

End Sub

Private Sub optServiceDafi_Click()
If blnControl Then optService_Reset
End Sub


Private Sub optServiceDG_Click()
If blnControl Then optService_Reset
End Sub

Private Sub optServiceInspection_Click()
If blnControl Then optService_Reset

End Sub

Private Sub optServiceOpTrf_Click()
If blnControl Then optService_Reset
End Sub

Private Sub optServiceRisques_Click()
If blnControl Then optService_Reset
End Sub

Private Sub optServiceSOBI_Click()
If blnControl Then optService_Reset
End Sub



Private Function cmdImport_MvtP0_Inspection(lInput As String) As Boolean
Dim iReturn As Integer

cmdImport_MvtP0_Inspection = False

MsgTxt = Space$(recCptMvtLen)
Mid$(MsgTxt, 35, memoCptMvtLen) = mId$(lInput, 1, memoCptMvtLen)
MsgTxtIndex = 0
srvCptMvtGetBuffer recCptMvt

Select Case currentAction
    Case "Inspection_ComptesSousSurveillance"
        If mCompte <> recCptMvt.Compte Then
            mCompte = recCptMvt.Compte
            IGTable.K2 = mId$(mCompte, 1, 5)
            iReturn = tableElpTable_Read(IGTable)
            If iReturn = 0 Then
                blnIGTable = True
            Else
                blnIGTable = False
            End If
        End If
        cmdImport_MvtP0_Inspection = blnIGTable
    Case "Inspection_MouvementsComplémentaires"
        If recCptMvt.CptComplémentaire <> "0" Then cmdImport_MvtP0_Inspection = True
    Case "Inspection_DateDeValeur"
       If recCptMvt.AmjValeur < mIGAMJVal_Min Then cmdImport_MvtP0_Inspection = True
       If recCptMvt.AmjValeur > mIGAMJVal_Max Then cmdImport_MvtP0_Inspection = True
    Case "Inspection_MouvementsManuels"
        If recCptMvt.ProgrammeSaisie = "CPJ030    " Then cmdImport_MvtP0_Inspection = True
    Case "Inspection_MouvementsPersonnel"
        If recCptMvt.Compte > "60000000000" And recCptMvt.Compte < "69999999999" Then cmdImport_MvtP0_Inspection = True
    Case "Inspection_MouvementsNonAutorisés"
        recCptInfo.Devise = recCptMvt.Devise
        recCptInfo.Numéro = recCptMvt.Compte
        mdbCptInfoP0_Find recCptInfo
        cmdImport_MvtP0_Inspection = cmdImport_MvtP0_ServiceNonAutorisé
        
End Select

'Select Case currentAction
'    Case "Inspection_ComptesSousSurveillance"
'        If mCompte <> mId$(lInput, 10, 11) Then
'            mCompte = mId$(lInput, 10, 11)
'            IGTable.K2 = mId$(mCompte, 1, 5)
'            iReturn = tableElpTable_Read(IGTable)
'            If iReturn = 0 Then
'                blnIGTable = True
'            Else
'                blnIGTable = False
'            End If
'        End If
'        cmdImport_MvtP0_Inspection = blnIGTable
'    Case "Inspection_MouvementsComplémentaires"
'        If mId$(lInput, 143, 1) <> "0" Then cmdImport_MvtP0_Inspection = True
'    Case "Inspection_DateDeValeur"
'       If mId$(lInput, 63, 8) < mIGAMJVal_Min Then cmdImport_MvtP0_Inspection = True
'      If mId$(lInput, 63, 8) > mIGAMJVal_Max Then cmdImport_MvtP0_Inspection = True
'    Case "Inspection_MouvementsManuels"
'        If mId$(lInput, 141, 1) <> "0" Then cmdImport_MvtP0_Inspection = True

'End Select

End Function

Public Sub cmdPrint_JournalComptable()
Dim Msg As String
If Not IsNull(cmdImport_MvtP0) Then Exit Sub
Msg = Space$(50): Mid$(Msg, 13, 3) = mService

''If optJournalTriP Then
''    blnPièceRupture = True: txtPièceRupture = "Service_Pièce"
''Else
''    blnPièceRupture = False: txtPièceRupture = "Service_Compte"
''End If
''If mService = "080" Then blnPièceRupture = False: txtPièceRupture = "Liste_Compte"

prtCompta_Monitor Msg, "Journal des mouvements comptables du " & dateImp(mJournalAmj) & "au " & dateImp(mJournalAmjAu), txtPièceRupture
If mService = "001" Then
    mService = "002"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "Journal des mouvements comptables du " & dateImp(mJournalAmj), txtPièceRupture
     mService = "003"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "Journal des mouvements comptables du " & dateImp(mJournalAmj), txtPièceRupture
   mService = "001"
End If

End Sub

Public Sub cmdPrint_Service()
Dim Msg As String

blnImport_Mvtp0 = False

If chkJournalComptable = "1" Then cmdPrint_JournalComptable
If chkAvis = "1" Then
    If optServiceSOBI Then cmdPrint_Avis_SOBI "SOBI"
    cmdPrint_Avis " "
    If optServiceCaisse Then cmdPrint_Avis "Copie"          ' avis en 2 exemplaires
End If

If chkTOpe = "1" Then
    Select Case mService
        Case Is = "001"
                frmPrêt_Show
                frmPrêt.Msg_Rcv "PRÊTSPC     " & "BIA_EXPLOIT"
         Case Is = "041"
                frmGarantie_Show
                frmGarantie.Msg_Rcv "DAFI_GARANT " & "BIA_EXPLOIT"
        Case Is = "080"
            If Not IsNull(cmdImport_MvtP0) Then Exit Sub
            Msg = Space$(50): Mid$(Msg, 13, 3) = mService
            prtCompta_Monitor Msg, "Comptes sous surveillance  : mouvements comptables du " & dateImp(mJournalAmj), txtPièceRupture
   End Select
End If

If chkSolde1 = "1" Then
    frmCompteSolde_Show
    frmCompteSolde.Msg_Rcv "Compte_" & mService
End If
If chkSolde2 = "1" Then
    frmCompteSolde_Show
    frmCompteSolde.Msg_Rcv "Compte_" & mService & "_2"
End If
If chkSolde3 = "1" Then
    frmCompteSolde_Show
    frmCompteSolde.Msg_Rcv "Compte_" & mService & "_3"
End If
If chkSolde4 = "1" Then
    frmCompteSolde_Show
    frmCompteSolde.Msg_Rcv "Compte_" & mService & "_4"
End If
If chkSolde5 = "1" Then
    frmCompteSolde_Show
    frmCompteSolde.Msg_Rcv "Compte_" & mService & "_5"
End If
If chkSolde6 = "1" Then
    frmCompteSolde_Show
    frmCompteSolde.Msg_Rcv "Compte_" & mService & "_6"
End If

End Sub


Public Sub cmdPrint_Inspection()
Dim Msg As String

cmdImportCptP0_click

If chkJournalComptable = "1" Then mService = "001": cmdPrint_JournalComptable: mService = "080"

If chkTOpe = "1" Then
    currentAction = "Inspection_ComptesSousSurveillance"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "Comptes sous surveillance  : mouvements comptables du " & dateImp(mJournalAmj), txtPièceRupture
    currentAction = ""
End If

If chkSolde1 = "1" Then
    currentAction = "Inspection_DateDeValeur"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "Dates de valeur hors limites ( - 2 mois, + 10 jours) : mouvements comptables  du " & dateImp(mJournalAmj), txtPièceRupture
    currentAction = ""
End If

If chkSolde2 = "1" Then
    currentAction = "Inspection_MouvementsComplémentaires"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "mouvements comptables complémentaires du " & dateImp(mJournalAmj), txtPièceRupture
    currentAction = ""
End If

If chkSolde3 = "1" Then
    currentAction = "Inspection_MouvementsManuels"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "mouvements comptables manuels du " & dateImp(mJournalAmj), txtPièceRupture
    currentAction = ""
End If

If chkSolde4 = "1" Then
    currentAction = "Inspection_MouvementsPersonnel"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "mouvements sur comptes du personnel du " & dateImp(mJournalAmj), txtPièceRupture
    currentAction = ""
End If


If chkSolde5 = "1" Then
    currentAction = "Inspection_MouvementsNonAutorisés"
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
    prtCompta_Monitor Msg, "Contrôle des autorisations des mouvements du " & dateImp(mJournalAmj), txtPièceRupture
    currentAction = ""
End If

If chkSolde6 = "1" Then
    currentAction = "Inspection_CompteSensSolde"
'    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
    Msg = Space$(50): Mid$(Msg, 13, 3) = mService
 '   prtCompta_Monitor Msg, "mouvements sur comptes du personnel du " & dateImp(mJournalAmj), txtPièceRupture
    currentAction = ""
End If

End Sub

Public Function cmdImport_MvtP0_ServiceNonAutorisé() As Boolean
Dim wService As String * 3, blnContrôle As Boolean, blnAutorisé As Boolean

blnContrôle = False: blnAutorisé = False
wService = recCptMvt.Service
Select Case wService
    Case "002", "003": wService = "001"
    Case "051": wService = "050"
End Select

If recCptInfo.ServiceAutorisé1 <> "000" Then
    blnContrôle = True
    If recCptInfo.ServiceAutorisé1 = wService Then blnAutorisé = True
End If

If recCptInfo.ServiceAutorisé2 <> "000" Then
    blnContrôle = True
    If recCptInfo.ServiceAutorisé2 = wService Then blnAutorisé = True
End If

If recCptInfo.ServiceAutorisé3 <> "000" Then
    blnContrôle = True
    If recCptInfo.ServiceAutorisé3 = wService Then blnAutorisé = True
End If

If recCptInfo.ServiceAutorisé4 <> "000" Then
    blnContrôle = True
    If recCptInfo.ServiceAutorisé4 = wService Then blnAutorisé = True
End If

If recCptInfo.ServiceAutorisé5 <> "000" Then
    blnContrôle = True
    If recCptInfo.ServiceAutorisé5 = wService Then blnAutorisé = True
End If

If blnContrôle And Not blnAutorisé Then
    cmdImport_MvtP0_ServiceNonAutorisé = True
Else
    cmdImport_MvtP0_ServiceNonAutorisé = False
End If


End Function
Public Sub cmdPrint_Avis(lMsg As String)
Dim wBiaRAc As String * 5, blnOk As Boolean, iReturn As Integer

''If Not blnImport_Mvtp0 Then
    If Not IsNull(cmdImport_MvtP0) Then Exit Sub
''End If


mdbMvtP0.tableMvtP0_Open

recMvtp0.Method = "MoveFirst" '

Do
    iReturn = tableMvtP0_Read(recMvtp0)
    If iReturn = 0 Then
    
        blnOk = False
        
        If mId$(recMvtp0.Text, 142, 1) <> "0" Then
            blnOk = True
        Else
            If mId$(recMvtp0.Text, 172, 4) = "ARIS" Then
   
                wBiaRAc = mId$(recMvtp0.Text, 10, 5)
                
                If wBiaRAc > "10000" And wBiaRAc < "50000" Then blnOk = True
                If wBiaRAc > "79999" Then blnOk = True
                If wBiaRAc = "20000" Then blnOk = False                 ' sauf SG
            End If
        End If
        
        If mId$(recMvtp0.Text, 10, 11) = "00038890007" Then blnOk = False
        If blnOk Then
            MsgTxtIndex = 0
            MsgTxt = Space$(recCptMvtLen)
            Mid$(MsgTxt, 35, memoCptMvtLen) = mId$(recMvtp0.Text, 1, memoCptMvtLen)

            srvCptMvtGetBuffer recCptMvt
            prtAvis_CptMvt recCptMvt, lMsg
        End If
    End If
    recMvtp0.Method = "MoveNext"
Loop Until iReturn <> 0

End Sub
Public Sub cmdPrint_Avis_SOBI(lMsg As String)
Dim wBiaRAc As String * 5, blnOk As Boolean, iReturn As Integer
Dim xInput As String, X8 As String

If chkJournalAmj = "1" Then
    Open Trim(paramComptaExt_Mvt_Import) & "_Mois" For Input As #1
Else
    Open paramComptaExt_Mvt_Import For Input As #1
End If
Call DTPicker_Control(txtJournalAmj, mJournalAmj)
Call DTPicker_Control(txtJournalAmjAu, mJournalAmjAu)


Do Until EOF(1)
    Line Input #1, xInput
    
        
    If mId$(xInput, 1, 3) = "$$$" Then Close: Exit Sub

    
        blnOk = False
        
        If mId$(xInput, 10, 11) = "00038897009" Then  ' compte Vir à imputer
        
            blnOk = True
            If chkJournalAmj = "1" Then
                 X8 = mId$(xInput, 163, 8)
                If X8 < mJournalAmj Or X8 > mJournalAmjAu Then blnOk = False
            End If
            
            If blnOk Then
              If mId$(xInput, 25, 3) = "010" Then blnOk = False  ' sauf mvt du service
            End If
            If blnOk Then
                MsgTxtIndex = 0
                MsgTxt = Space$(recCptMvtLen)
                Mid$(MsgTxt, 35, memoCptMvtLen) = mId$(xInput, 1, memoCptMvtLen)
    
                srvCptMvtGetBuffer recCptMvt
                prtAvis_CptMvt recCptMvt, lMsg
            End If
        End If
Loop

Close

End Sub

